name: macOS - Create Sparkle Test Builds

on:
  workflow_dispatch:
    inputs:
      branch_prefix:
        description: 'Branch prefix (e.g., username/)'
        required: true
        type: string

jobs:
  build-outdated:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger test outdated build
        run: |
          gh workflow run macos_build_notarized.yml \
            --ref "${branch_prefix}outdated" \
            -f release-type=review \
            -f create-dmg=true

  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger test release build
        run: |
          gh workflow run macos_build_notarized.yml \
            --ref "${branch_prefix}release" \
            -f release-type=review \
            -f create-dmg=true

  build-phased:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger test phased build
        run: |
          gh workflow run macos_build_notarized.yml \
            --ref "${branch_prefix}phased" \
            -f release-type=review \
            -f create-dmg=true

  mattermost:
    name: Send Mattermost message
    needs: [build-outdated, build-release, build-phased]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Mattermost message
        if: success() || failure()
        env:
          WORKFLOW_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          bundle exec fastlane run mattermost_send_message \
            mattermost_webhook_url:${{ secrets.MM_WEBHOOK_URL }} \
            github_handle:${{ github.actor }} \
            template_name:$([[ "${{ job.status }}" == "success" ]] && echo "sparkle-test-builds-complete" || echo "sparkle-test-builds-failed")
