name: iOS - Make ad-hoc build

defaults:
  run:
    working-directory: iOS

on:
  workflow_dispatch:
    inputs:
      suffix:
        description: "Text to append at the end of the build name"
        required: false
      asana-task-url:
        description: "Asana task URL"
        required: false
        type: string
      build-type:
        description: "Build Configuration"
        type: choice
        required: true
        default: 'Alpha'
        options:
           - Alpha
           - Release
           - Experimental

jobs:
  make-adhoc:
    runs-on: macos-15-xlarge
    name: Make ad-hoc build

    env:
      RUNS_ON: macos-15-xlarge # keep this in sync with runs-on above

    steps:

      - name: Register SSH keys for access to certificates
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_FASTLANE_MATCH }}

      - name: Check out the code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Start measuring duration
        id: start-duration
        uses: ./.github/actions/measure-duration
        with:
          mode: start

      - name: Select Xcode
        uses: ./.github/actions/select-xcode-version
        with:
          xcode-version: ${{ github.event.inputs.build-type == 'Experimental' && '26.2' || '' }}

      - name: Add commit SHA to plist
        run: |
          echo "Setting DDG_COMMIT_SHA to ${{ github.sha }}"

          plist_path="DuckDuckGo/Info.plist"
          /usr/libexec/PlistBuddy -c "Add :DDG_COMMIT_SHA string ${{ github.sha }}" "${plist_path}" \
            || /usr/libexec/PlistBuddy -c "Set :DDG_COMMIT_SHA ${{ github.sha }}" "${plist_path}"

          experimental_plist_path="DuckDuckGo/Info-Experimental.plist"
          /usr/libexec/PlistBuddy -c "Add :DDG_COMMIT_SHA string ${{ github.sha }}" "${experimental_plist_path}" \
            || /usr/libexec/PlistBuddy -c "Set :DDG_COMMIT_SHA ${{ github.sha }}" "${experimental_plist_path}"

      - name: Setup Ruby and dependencies
        uses: ./.github/actions/setup-ruby
        with:
          working-directory: iOS
          cache-key-prefix: ios-ruby

      - name: Archive and upload the app
        id: archive-and-upload
        env:
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_KEY_ISSUER: ${{ secrets.APPLE_API_KEY_ISSUER }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          app_version="$(cut -d ' ' -f 3 < Configuration/Version.xcconfig)"
          build_number="$(cut -d ' ' -f 3 < Configuration/BuildNumber.xcconfig)"
          echo "app_version=${app_version}" >> $GITHUB_ENV
          echo "build_number=${build_number}" >> $GITHUB_ENV

          lane_to_use="adhoc"
          if [[ "${{ github.event.inputs.build-type }}" == "Release" ]]; then
            lane_to_use="release_adhoc"
          elif [[ "${{ github.event.inputs.build-type }}" == "Experimental" ]]; then
            lane_to_use="experimental_adhoc"
          fi

          if [[ -n "${{ github.event.inputs.suffix }}" ]]; then
            bundle exec fastlane ${lane_to_use} suffix:${{ github.event.inputs.suffix }}
          else
            bundle exec fastlane ${lane_to_use}
          fi

      - name: Measure App Size
        if: steps.archive-and-upload.outcome == 'success'
        continue-on-error: true
        uses: ./.github/actions/measure-app-size
        with:
          report-file: "iOS/App Thinning Size Report.txt"
          download-size-pixel-name: "m_ci_apple_ios_adhoc_download_size"
          installation-size-pixel-name: "m_ci_apple_ios_adhoc_installation_size"
          app-version: ${{ env.app_version }}
          build-number: ${{ env.build_number }}
          suffix: ${{ github.event.inputs.suffix }}

      - name: Report job duration
        if: success() || (always() && steps.archive-and-upload.outcome == 'failure')
        continue-on-error: true
        uses: ./.github/actions/measure-duration
        with:
          mode: stop
          start-timestamp: ${{ steps.start-duration.outputs.start-timestamp }}

      - name: Set filenames
        run: |
          echo "ipa_filename=${{ env.output_name }}.ipa" >> $GITHUB_ENV
          echo "dsyms_filename=${{ env.output_name }}.app.dSYM.zip" >> $GITHUB_ENV

      - name: Set paths
        run: |
          echo "ipa_path=${{ github.workspace }}/iOS/${{ env.ipa_filename }}" >> $GITHUB_ENV
          echo "dsyms_path=${{ github.workspace }}/iOS/${{ env.dsyms_filename }}" >> $GITHUB_ENV

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ipa_filename }}
          path: ${{ env.ipa_path }}

      - name: Upload dSYMs artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.dsyms_filename }}
          path: ${{ env.dsyms_path }}

      - name: Upload dSYMs to S3
        id: upload-dsyms-to-s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_RELEASE_S3 }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_RELEASE_S3 }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          DSYM_LOCAL_PATH: "${{ env.dsyms_path }}"
          DSYM_NAME: ${{ env.dsyms_filename }}
          DSYM_URL_ROOT: ${{ vars.IPA_URL_ROOT }}
          RELEASE_BUCKET_NAME: ${{ vars.RELEASE_BUCKET_NAME }}
          RELEASE_BUCKET_PREFIX: ${{ vars.IOS_RELEASE_BUCKET_PREFIX }}
          REVIEW_BUILDS_BUCKET_PREFIX: ${{ vars.REVIEW_BUILDS_BUCKET_PREFIX }}
        run: |
          ref_sha="$(git rev-parse --short HEAD)"
          test_build_s3_path="s3://${RELEASE_BUCKET_NAME}/${RELEASE_BUCKET_PREFIX}/${REVIEW_BUILDS_BUCKET_PREFIX}/${ref_sha}/"
          dsym_s3_path="${test_build_s3_path}${DSYM_NAME}"
          echo "test-build-s3-path=${test_build_s3_path}" >> $GITHUB_OUTPUT

          # Calculate the URL for the dSYM to report it later
          s3_bucket_url="s3://${RELEASE_BUCKET_NAME}/${RELEASE_BUCKET_PREFIX}/"
          dsym_url="${dsym_s3_path/#${s3_bucket_url}/${DSYM_URL_ROOT}}" # replace S3 bucket url with CDN URL
          echo "dsym-url=${dsym_url}" >> $GITHUB_OUTPUT
          aws s3 cp $DSYM_LOCAL_PATH $dsym_s3_path --acl public-read
          echo "dsym-s3-path=${dsym_s3_path}" >> $GITHUB_OUTPUT

      - name: Upload IPA to S3
        id: upload-ipa-to-s3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_RELEASE_S3 }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_RELEASE_S3 }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          TEST_BUILD_S3_PATH: ${{ steps.upload-dsyms-to-s3.outputs.test-build-s3-path }}
          IPA_LOCAL_PATH: ${{ env.ipa_path }}
          IPA_NAME: ${{ env.ipa_filename }}
          IPA_URL_ROOT: ${{ vars.IPA_URL_ROOT }}
          RELEASE_BUCKET_NAME: ${{ vars.RELEASE_BUCKET_NAME }}
          RELEASE_BUCKET_PREFIX: ${{ vars.IOS_RELEASE_BUCKET_PREFIX }}
        run: |
          ipa_s3_path="${TEST_BUILD_S3_PATH}${IPA_NAME}"

          # Calculate the URL for the dSYM to report it later
          s3_bucket_url="s3://${RELEASE_BUCKET_NAME}/${RELEASE_BUCKET_PREFIX}/"
          ipa_url="${ipa_s3_path/#${s3_bucket_url}/${IPA_URL_ROOT}}" # replace S3 bucket url with CDN URL
          echo "ipa-url=${ipa_url}" >> $GITHUB_OUTPUT

          aws s3 cp $IPA_LOCAL_PATH $ipa_s3_path --acl public-read
          echo "ipa-s3-path=${ipa_s3_path}" >> $GITHUB_OUTPUT

      - name: Report success
        env:
          ASANA_TASK_URL: ${{ github.event.inputs.asana-task-url }}
          IPA_URL: ${{ steps.upload-ipa-to-s3.outputs.ipa-url }}
          IPA_S3_PATH: ${{ steps.upload-ipa-to-s3.outputs.ipa-s3-path }}
          DSYM_URL: ${{ steps.upload-dsyms-to-s3.outputs.dsym-url }}
          DSYM_S3_PATH: ${{ steps.upload-dsyms-to-s3.outputs.dsym-s3-path }}
          WORKFLOW_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ASANA_ACCESS_TOKEN: ${{ secrets.ASANA_ACCESS_TOKEN }}
        run: |
          echo "## Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [${IPA_S3_PATH}](${IPA_URL})" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [${DSYM_S3_PATH}](${DSYM_URL})" >> $GITHUB_STEP_SUMMARY

          if [[ -n "$ASANA_TASK_URL" ]]; then
            bundle exec fastlane run asana_add_comment \
              task_url:"$ASANA_TASK_URL" \
              comment:"New build is available at ${IPA_URL}."
          fi
