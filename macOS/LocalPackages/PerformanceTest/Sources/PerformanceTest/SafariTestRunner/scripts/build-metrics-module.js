#!/usr/bin/env node

/**
 * Build script to convert performanceMetrics.js used in Swift into a module
 * This runs during npm install/prepare
 */

const fs = require('fs');
const path = require('path');

// Fix path resolution - go up to Resources directory correctly
const SOURCE_PATH = path.resolve(__dirname, '../../Resources/performanceMetrics.js');
const DEST_PATH = path.resolve(__dirname, '../src/constants/metricsScript.js');

// Validate source exists
if (!fs.existsSync(SOURCE_PATH)) {
    console.error(`Error: Source file not found at ${SOURCE_PATH}`);
    console.error('Please ensure performanceMetrics.js exists in the Resources directory');
    process.exit(1);
}

// Ensure constants directory exists
const constantsDir = path.dirname(DEST_PATH);
if (!fs.existsSync(constantsDir)) {
    fs.mkdirSync(constantsDir, { recursive: true });
}

try {
    // Read the performance metrics script
    const scriptContent = fs.readFileSync(SOURCE_PATH, 'utf8');

    // Create the module content
    const moduleContent = `/**
 * Auto-generated module containing the performance metrics script
 * Generated from: ${SOURCE_PATH}
 * Generated at: ${new Date().toISOString()}
 *
 * DO NOT EDIT THIS FILE DIRECTLY
 * Edit the source file and run 'npm run build:metrics' to regenerate
 */

// The performance metrics script as a string constant
const METRICS_SCRIPT = ${JSON.stringify(scriptContent)};

module.exports = { METRICS_SCRIPT };
`;

    // Write the module
    fs.writeFileSync(DEST_PATH, moduleContent);

    console.log(`âœ“ Generated metrics module at: ${DEST_PATH}`);
    console.log(`  Source: ${SOURCE_PATH}`);
    console.log(`  Size: ${scriptContent.length} bytes`);
} catch (error) {
    console.error(`Error building metrics module: ${error.message}`);
    process.exit(1);
}